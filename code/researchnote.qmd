---
title: "researchnote"
format: html
editor: visual
#echo: false # 不显示代码仅显示输入
code-fold: true # 代码折叠
code-annotations: hover
---
# Setup
```{r}
#| label: setup
#| include: FALSE
#| echo: FALSE
set.seed(0508)
options (warn = -1)
# packbirth loading
library(pacman)
p_load("rio",
       "here",
       "tidyverse",
       "scales",
       "car",
       "haven",
       "cobalt",
       "ggplot2",
       "gt",
       "tinytable",
       "modelsummary")
```

# dataLoda

```{r}
#| label: pre data
#| echo: true
data <- read_sav("../data/data.sav") %>%
  select(.,rid,"A1","A2","A3","A4","A8","A10","A11","E1","E6","C1","C1","C2","C8","C5__6","C5__4","C5__9","X1a","X2a","X3a","X4a","X5a","X6a","X1b","X2b","X3b","X4b","X5b","X6b","M1__1","M2","M3","M4__1","M4__2","M4__3","M4__4","M4__5","M4__6","M5__1","M5__2","M5__3","M5__4","M6__1","M6__2","M6__3","M6__4") %>%
  rename(
    id = rid,
    gender = A1,
    rural = A2,
    age = A3,
    race = A4,
    marriage = A8,
    edu = E1,
    party = E6,
    incomeFam_level = A10,
    occ = A11,
    newspol = C1,
    internetuse = C2,
    trustGross = C5__6,
    trustGover = C5__4,
    trustLocal = C5__9,
    demSuit = M1__1
  ) 
data <- data %>%
  mutate(across(.cols = X1a:X6b,.fns = as.factor)
  )

data <-  data %>%
  mutate(treat = case_when(
    data$X1b != "NA" ~ 1, # <1>
    data$X1a != "NA" ~ 0
  ),
  age = 2024 - age)


# data_tre <- data %>%
#   subset(.,X1b != "NA") %>%
#   select(.,-c("X1a","X2a","X3a","X4a","X5a"))

# data_con <- data %>%
#   subset(.,X1a != "NA") %>%
#   select(.,-c("X1b","X2b","X3b","X4b","X5b","X6b"))


```


::: {.callout-note collapse="true"}
1. X1a是对照组；X1b为实验组。
2. 注释代码单独挑选出实验组和对照组
3. 一键注释：Ctrl+shift+C.
:::

:::{.callout-important collapse="true"}
黄海峰在2011年的问卷中只涉及大学生，2014年包括一项大学生和一项在线网络调查。在给大学生的问题里面给出了中国作为参考(Huang2017a)；而2014年的网络调查没有出中国作为参考(Huang2015).可以看两篇文章的appendix以及Huang2017a里面的一段话。The online survey experiment and the college survey had the same topics for the socioeconomic information questions, while the answers for some questions were somewhat dif- ferent since the world’s socioeconomic conditions did not stay constant over the three years between the surveys. To give the students some bases for judgment (since some of the questions asked about somewhat abstract issues, e.g., income inequality), relevant statistics for China were provided in many of the socioeconomic questions in the college survey. The online survey experiment removed such reference information about China in the socioe- conomic questions to make sure the respondents’ answers were not primed by information about China.
:::


# dataAlysis
```{r}
#| label: dataAlysis
#| warning: false
#| code-annotations: below
## control variable
data$newspol <- 6 - data$newspol
data$edu <- Recode(data$edu,"1:3 = 1;4:5 = 2;6:7 = 3;8:9 = 4")
data$party <- Recode(data$party,"2:4 = 0")
data$rural <- Recode(data$rural,"c(1,3) = 0;2 = 1")
data$race <- Recode(data$race,"2:5 = 0")
data$marriage <- Recode(data$marriage,"2 = 1;3:6 = 0;1 = 0")
data$gender <- 2 - data$gender
data$treat <- as.factor(data$treat)

## outcome variable
data$demSolve <- Recode(data$M3,"2 = 0")
data$M4__1 <- 5 - data$M4__1 # <1>
data$M4__2 <- 5 - data$M4__2
data$M4__3 <- 5 - data$M4__3
data$M4__5 <- 5 - data$M4__5
data$dempositive <- data %>%
  select(.,M4__1,M4__2,M4__3,M4__5) %>%
  rowMeans(na.rm = TRUE) 

data$M5__1 <- 5 - data$M5__1
data$M5__2 <- 5 - data$M5__2
data$M5__3 <- 5 - data$M5__3
data$M5__4 <- 5 - data$M5__4
data$demStrong <- data %>%
  select(.,M5__1,M5__2,M5__3,M5__4) %>%
  rowMeans(na.rm = TRUE) 

data$nationalism <- data %>%
  select(.,M6__1,M6__2,M6__3,M6__4) %>%
  rowMeans(na.rm = TRUE)

data <- data %>%
  mutate(
    cate4_x1 = case_when(
      X1b == 1 ~ "-2",
      X1a == 1 ~ "-2",
      X1b == 2 ~ "-1",
      X1a == 2 ~ "-1",
      X1b == 3 ~ "0",
      X1a == 3 ~ "0",
      X1b == 4 ~ "1",
      X1a == 4 ~ "1"
    ),
    cate3_x1 = case_when(
      cate4_x1 == "-2" ~ "-1",
      cate4_x1 == "-1" ~ "-1",
      cate4_x1 == "0" ~ "0",
      cate4_x1 == "1" ~ "1"
    ),
    cate4_x2 = case_when(
      X2b == 1 ~ "-1",
      X2a == 1 ~ "-1",
      X2b == 2 ~ "0",
      X2a == 2 ~ "0",
      X2b == 3 ~ "1",
      X2a == 3 ~ "1",
      X2b == 4 ~ "2",
      X2a == 4 ~ "2"
    ),
    cate3_x2 = case_when(
      cate4_x2 == "-1" ~ "-1",
      cate4_x2 == "0" ~ "0",
      cate4_x2 == "1" ~ "1",
      cate4_x2 == "2" ~ "1"
    ),
    cate4_x3 = case_when(
      X3b == 1 ~ "-3",
      X3a == 1 ~ "-3",
      X3b == 2 ~ "-2",
      X3a == 2 ~ "-2",
      X3b == 3 ~ "-1",
      X3a == 3 ~ "-1",
      X3b == 4 ~ "0",
      X3a == 4 ~ "0"
    ),
    cate3_x3 = case_when(
      cate4_x3 == "-2" ~ "-1",
      cate4_x3 == "-1" ~ "-1",
      cate4_x3 == "-3" ~ "-1",
      cate4_x3 == "0" ~ "0"
    ),
    cate4_x4 = case_when(
      X4b == 1 ~ "-1",
      X4a == 1 ~ "-1",
      X4b == 2 ~ "0",
      X4a == 2 ~ "0",
      X4b == 3 ~ "1",
      X4a == 3 ~ "1",
      X4b == 4 ~ "2",
      X4a == 4 ~ "2",
    ),
    cate3_x4 = case_when(
      cate4_x4 == "-1" ~ "-1",
      cate4_x4 == "0" ~ "0",
      cate4_x4 == "1" ~ "1",
      cate4_x4 == "2" ~ "1"
    ),
    cate4_x5 = case_when(
      X5b == 1 ~ "0",
      X5a == 1 ~ "0",
      X5b == 2 ~ "1",
      X5a == 2 ~ "1",
      X5b == 3 ~ "2",
      X5a == 3 ~ "2",
      X5b == 4 ~ "3",
      X5a == 4 ~ "3",
    ),
    cate3_x5 = case_when(
      cate4_x5 == "0" ~ "0",
      cate4_x5 == "3" ~ "1",
      cate4_x5 == "1" ~ "1",
      cate4_x5 == "2" ~ "1" 
    ),
    cate4_x6 = case_when(
      X6b == 1 ~ "-2",
      X6a == 1 ~ "-2",
      X6b == 2 ~ "-1",
      X6a == 2 ~ "-1",
      X6b == 3 ~ "0",
      X6a == 3 ~ "0",
      X6b == 4 ~ "1",
      X6a == 4 ~ "1"
    ),
    cate3_x6 = case_when(
      cate4_x6 == "-2" ~ "-1",
      cate4_x6 == "-1" ~ "-1",
      cate4_x6 == "0" ~ "0",
      cate4_x6 == "1" ~ "1"
    )
  ) %>%
  mutate(across(.cols = cate4_x1:cate3_x6,.fns = as.numeric),
         escore4_sum = rowSums( across(c(cate4_x1,cate4_x2,cate4_x3,cate4_x4,cate4_x5,cate4_x6))),
         escore3_sum = rowSums(across(c(cate3_x1,cate3_x2,cate3_x3,cate3_x4,cate3_x5,cate3_x6)))
         )

rawdata <- data 

data <- data %>%      # <2> 
  mutate(
    escore4_summean = mean(escore4_sum),
    escore3_summean = mean(escore3_sum),
    escore3_sumsd = sd(escore3_sum), # <3>
    escore4_sumsd = sd(escore4_sum)
  )  %>%
  mutate(
    cate_over3 = case_when(
      `escore3_sum` >= `escore3_sumsd` ~ "1",
      `escore3_sum` <=   (-1)*(`escore3_sumsd`) ~ "-1",
      `escore3_sum` < `escore3_sumsd` &`escore3_sum` > (-1)*(`escore3_sumsd`) ~ "0"
    ),
    cate_over4 = case_when(
      `escore4_sum` >= `escore4_sumsd` ~ "1",
      `escore4_sum` <=   (-1)*(`escore4_sumsd`) ~ "-1",
      `escore4_sum` < `escore4_sumsd` &`escore4_sum` > (-1)*(`escore4_sumsd`) ~ "0"
    )
  )


# temp <- data %>%
#   select(.,id,escore4_sum,escore4_sumsd,escore3_sum,escore3_sumsd,cate_over4,cate_over3)
```

## groupData
```{r}

```

::: {.callout-important}
1.这里求标准差需要注意的是到底是先分组再求还是在所有人中求。结果肯定不一样，目前直接求。

2.过度高估和低估除了用标准差，直接用均值的效果怎么样，以及用数值减去均值怎么样？
:::

# fig1

```{r}
#| label: fig1
#| fig-cap: The Respondents’ Evaluation about TaiWan
#| fig-cap-location: top
fig1 <- data %>%
  ggplot(.,aes(x = escore4_sum)) +
  geom_histogram(bins = 30)
fig1
```

1. 题干中是最高民主价值观越低，因此要转换
2. across函数跨列操作，另外将因子(factor)转化成数值(numeric)，可能会造成数据改变，因此要先转化成字符型(character),再转化成数值 y = as.numeric(as.character(x))。好在这里的数据一开始都是字符型。

::: {.callout-warning collapse="true"}
目前民主肯定性回答的只包括1/2/3/5，2/4 不太像。
:::


## table1

```{r}
#| label: tbl-tre2con
#| tbl-cap: "Balance table"
#| eval: true

table1 <- data %>%
  select(.,treat,age,gender,edu,party,marriage,incomeFam_level,occ,newspol,internetuse) %>%
  datasummary_balance(
  ~ treat,
  data = .,
  title = "Balance Description",
  stars = TRUE,
  output = "tinytable" 
)     
#save_tt("../outputs/table1.docx")
table1 # <4>
```
4. 这里默认输出的是tinytable格式，也可以使用gt格式。

::: {.callout-warning collapse="true"}
定制化表格后，如果要保存文件见<https://modelsummary.com/vignettes/appearance.html>部分Warning: Saving to file
:::

## treat & estimate
```{r}
table2 <- data %>%
  select(.,treat,cate_over4) %>%
  datasummary_crosstab(
    treat ~ cate_over4,
    data = .,
    output = "tinytable",
    statistic = 1 ~ 1 + N 
  ) %>%
   group_tt(
     j = list(
      "Estimate" = 3:5)
   )
  
table2

table3 <- datasummary(treat*demStrong ~ cate_over3 * (mean + sd),
                      stars = TRUE,
                      data = data,
                      sparse_header=FALSE)
table3
```


## t-test(outcome variable)

### aovtest

```{r}
#| lable: aovtest 
#| eval: false
#| warning: false
aovtest <- aov(demSolve~ as.factor(cate_over3), data = data)
```


# Regression
```{r}
#| label: regression
data$cate_over4 <- as.factor(data$cate_over4)
data$cate_over4 <- relevel(data$cate_over4, ref = "0")

## varibale_list
ls_ctrl <- c(
   "cate_over4-1" = "under",
    "cate_over41" = "over",
   "age" = "Age",
   "gender" = "Gender",
   "marriage" = "Marriage",
   "edu" = "Education",
   "party" = "Partymember",
   "rural" = "Residence",
   "incomeFamily_level" = "Family socialLevel",
   "occ" = "WorkUnite"
)
lm_positive <- lm(dempositive ~ treat * cate_over4+age+marriage+party+rural+race+gender,data = data)
lm_strong <- lm(demStrong ~ treat * cate_over4+age+marriage+party+rural+race+gender,data = data)
lm_solve <- lm(demSolve ~ treat * cate_over4+age+marriage+party+rural+race+gender,data = data)
lm_suit <- lm(demSuit ~ treat * cate_over4+age+marriage+party+rural+race+gender,data = data)
mlist <- list(
  "Dempositive" = lm_positive,
  "StrongLeader" = lm_strong,
  "Capbility" = lm_solve,
  "ChinaSuit" = lm_suit)

results <- msummary(mlist,
         #output = "kableExtra",
         stars = TRUE,
         coef_rename = ls_ctrl,
         gof_omit = "F",
         coef_omit = "(Intercept)") # <3>
results
# kableExtra::kable(results)

```
3. gof_omit和coef_omit的区别：coef_omit去掉变量中的variable,gof_omit去掉结果中的变量。


结果：
1. 按照三分类的话(cate_over3)，只对政治强人有正面影响。


